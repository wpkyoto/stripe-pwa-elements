<!doctype html>
<html dir="ltr" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
  <title>Stripe Elements - 開発用テストファイル</title>
  <script type="module" src="/build/stripe-elements.esm.js"></script>
  <script nomodule src="/build/stripe-elements.js"></script>
</head>
<body>
<div id="stripe"></div>

<script>
  // 基本的なカード要素の例
  const targetElement = document.getElementById('stripe');
  const cardElement = document.createElement('stripe-card-element');
  targetElement.appendChild(cardElement);

  customElements
    .whenDefined('stripe-card-element')
    .then(() => {
      // Stripe公開可能キーを設定
      cardElement.setAttribute('publishable-key', 'pk_test_51EMxG7KVC4SfzSeak35hZaAe91cpzKZE9eOQcVWpa7owYJeS30avCAF0lT1QUMKTbzepTIYgAgjly4AmgZuxxkcS00kQ40cBLe');
      // 郵便番号フィールドを表示
      cardElement.setAttribute('zip', 'true');
      // PaymentIntentのクライアントシークレットを設定
      cardElement.setAttribute('intent-client-secret', 'pi_3P03tlKzMYim9cy30Mrnv2xs_secret_xAOM1PdqEDq4mFfg1ff8pOjOm');
      // Payment Request Button（Apple Pay/Google Pay）を表示
      cardElement.setAttribute('show-payment-request-button', 'true');

      // Stripeが読み込まれた後にPayment Requestオプションを設定
      cardElement.addEventListener('stripeLoaded', () => {
        cardElement.setPaymentRequestOption({
          country: 'JP',
          currency: 'jpy',
          total: {
            label: 'Total',
            amount: 100,
          },
          requestShipping: false,
          requestPayerEmail: true,
        });
      });
    })
    .catch(e => {
      console.error('Error initializing stripe-card-element:', e);
    });

  // モーダル内カード要素の例
  const modalCardElement = document.createElement('stripe-card-element-modal');
  targetElement.appendChild(modalCardElement);

  customElements
    .whenDefined('stripe-card-element-modal')
    .then(() => {
      // モーダルを開く
      modalCardElement.setAttribute('open', 'true');
      // Stripe公開可能キーを設定
      modalCardElement.setAttribute('publishable-key', 'pk_test_51EMxG7KVC4SfzSeak35hZaAe91cpzKZE9eOQcVWpa7owYJeS30avCAF0lT1QUMKTbzepTIYgAgjly4AmgZuxxkcS00kQ40cBLe');

      // 内部のstripe-card-elementを取得
      return modalCardElement.getStripeCardElementElement();
    })
    .then(stripeElement => {
      // デフォルトのフォーム送信アクションを無効化
      stripeElement.setAttribute('should-use-default-form-submit-action', 'false');

      // フォーム送信イベントをリッスン
      stripeElement.addEventListener('formSubmit', async props => {
        try {
          // デバッグ用のエラーを発生させる
          throw new Error('debug');
        } catch (e) {
          console.log(e);
          stripeElement.setErrorMessage(`Error: ${e.message}`);
          stripeElement.updateProgress('failure');
        }
        return;

        // 実際の決済処理の例（コメントアウト）
        const {
          detail: { stripe, cardNumber, event },
        } = props;
        const result = await stripe.createPaymentMethod({
          type: 'card',
          card: cardNumber,
        });
        console.log(result);
        stripeElement.updateProgress('success');
      });

      // PaymentIntentのクライアントシークレットを設定（最新の属性名を使用）
      stripeElement.setAttribute('intent-client-secret', 'dummy');

      // デフォルトフォーム送信結果をリッスン
      stripeElement.addEventListener('defaultFormSubmitResult', async ({ detail }) => {
        if (detail instanceof Error) {
          console.error(detail);
          stripeElement.setErrorMessage(`Error: ${detail.message}`);
        } else {
          console.log(detail);
        }
      });
    })
    .catch(e => {
      console.log(e);
      const errorElement = document.createElement('p');
      errorElement.innerText = e.message;
      targetElement.appendChild(errorElement);
    });
</script>
<style>
  body {
    background-color: #e5e5e5;
  }
</style>
</body>
</html>
