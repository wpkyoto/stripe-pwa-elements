<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
    <title>Stencil Component Starter</title>
    <script type="module" src="/stripe-elements/stripe-elements.esm.js"></script>
    <script nomodule src="/stripe-elements/stripe-elements.js"></script>
  </head>
  <body>
      <nav>
        <ul>
          <li><a href="/">Example1: Dynamic Control</a></li>
          <li><a href="/example2.html">Example2: Static HTML</a></li>
        </ul>
      </nav>
      
      <div class="container">
        <div class="demo-section">
          <h1>Example1: Launch Form as a Modal Window</h1>
          <!-- 
            Get Stripe credentials and Payment Intent from form.
            In real applications, these values should be obtained from the server-side.
          -->
          <form id="open-modal-form" name="open-modal-form">
              <div id="error-message"></div>
              <fieldset>
                  <label>
                      <lenged>Stripe Publishable API Key</lenged>
                      <input name="stripe-publishable-api-key" type="text" placeholder="pk_test_..." />
                      <small>Use a key starting with "pk_test_" for test environment</small>
                  </label>
              </fieldset>
              <fieldset>
                  <label>
                      <lenged>Payment Intent Client Secret</lenged>
                      <p>
                          <small>You can get this value using Stripe CLI command:</small>
                          <br/>
                          <code>stripe payment_intents create --amount=100 --currency=jpy | jq .client_secret -r</code>
                      </p>
                      <input name="intent-client-secret" type="text" placeholder="pi_..." />
                  </label>
              </fieldset>
              <button type="submit">Launch Modal</button>
          </form>
          <div id="stripe"></div>
          <div id="result"></div>
        </div>

        <div class="docs-section">
          <h2>Documentation</h2>
          <p>
            <strong>Features of this example:</strong>
          </p>
          <ul>
            <li>Dynamically create and control components using JavaScript</li>
            <li>Accept user input (Stripe API Key, Payment Intent Client Secret)</li>
            <li>Display card input form inside a modal window</li>
            <li>Can also use Payment Request Button (Apple Pay, Google Pay, etc.) simultaneously</li>
            <li>A more flexible implementation pattern closer to real-world applications</li>
          </ul>
          <p>
            <strong>Difference from Example2:</strong>
            Example2 is a simple example using static HTML tags, while Example1 dynamically generates components
            and can change settings based on user input, making it a more practical example.
          </p>
          <p>
            <strong>Implementation Pattern:</strong>
          </p>
          <pre><code>// 1. Create modal and card element components dynamically
const modalElement = document.createElement('stripe-modal');
const stripeElement = document.createElement('stripe-card-element-modal');
const stripePaymentRequestElement = document.createElement('stripe-payment-request-button');

// 2. Append components to modal (order matters: Payment Request Button first)
modalElement.appendChild(stripePaymentRequestElement);
modalElement.appendChild(stripeElement);

// 3. Wait for custom elements to be defined
await customElements.whenDefined('stripe-modal');
await customElements.whenDefined('stripe-card-element-modal');

// 4. Initialize Stripe and configure components
await stripePaymentRequestElement.initStripe(publishableKey);
stripeElement.setAttribute('publishable-key', publishableKey);
stripeElement.setAttribute('intent-client-secret', clientSecret);

// 5. Set up custom form submit handler
stripeElement.addEventListener('formSubmit', async (props) => {
  const { detail: { stripe, cardNumberElement } } = props;
  const result = await stripe.createPaymentMethod({
    type: 'card',
    card: cardNumberElement,
  });
  // Handle result...
});

// 6. Open modal
modalElement.setAttribute('open', true);</code></pre>
        </div>
      </div>


    <script>
        // Get DOM element references
        const form = document.getElementById('open-modal-form')
        const resultElement = document.getElementById('result')
        const errorMessage = document.getElementById('error-message')
        const targetElement = document.getElementById('stripe');
        
        // Create modal component dynamically
        // This approach allows creating multiple modal instances as needed
        const modalElement = document.createElement('stripe-modal');

        /**
         * Remove mounted Stripe Elements when modal is closed
         * This ensures a clean state when opening the modal next time
         **/
        customElements.whenDefined('stripe-modal')
            .then(() => {
                modalElement.addEventListener('close', () => {
                    modalElement.innerHTML = ''
                })
            })

        // Handle form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault()
            
            // Validate input values
            const stripePublishableAPIKey = document['open-modal-form']['stripe-publishable-api-key'].value
            if (!stripePublishableAPIKey) {
                errorMessage.innerText = 'Stripe Publishable API Key is required'
                return
            }
            const paymentIntentClientSecret = document['open-modal-form']['intent-client-secret'].value
            if (!paymentIntentClientSecret) {
                errorMessage.innerText = 'Payment Intent Client Secret is required'
                return
            }

            /**
             * Dynamically create Web Components
             * 
             * stripe-card-element-modal: Card input component for use inside modal
             * stripe-payment-request-button: Payment Request API button (Apple Pay, Google Pay, etc.)
             * 
             * Note: These components must be placed inside the modal
             **/
            const stripeElement = document.createElement('stripe-card-element-modal');
            const stripePaymentRequestElement = document.createElement('stripe-payment-request-button');
            
            // Append components to modal (order matters: Payment Request Button first)
            modalElement.appendChild(stripePaymentRequestElement);
            modalElement.appendChild(stripeElement);
            
            // Append modal to DOM
            targetElement.appendChild(modalElement);

            /**
             * Wait for custom elements to be defined
             * Web Components load asynchronously, so they must be defined before use
             **/
            await customElements.whenDefined('stripe-modal')
            await customElements.whenDefined('stripe-payment-request-button')
            await customElements.whenDefined('stripe-card-element-modal')
            
            /**
             * Configure Payment Request Button
             * 
             * Settings for displaying native payment buttons (Apple Pay, Google Pay, etc.)
             * Only displayed when browser and device support it.
             * 
             * Parameter explanation:
             * - country: Country code (e.g., 'JP')
             * - currency: Currency code (e.g., 'jpy')
             * - total: Payment total amount and label
             * - requestShipping: Whether to request shipping information
             * - requestPayerEmail: Whether to request email address
             **/
            await stripePaymentRequestElement.setPaymentRequestOption({
                country: 'JP',
                currency: 'jpy',
                total: {
                    label: 'Total',
                    amount: 100,
                },
                requestShipping: false,
                requestPayerEmail: false,
            });

            /**
             * Initialize Stripe client
             * 
             * When initializing Stripe via Payment Request Button,
             * the same instance is shared with the card input component.
             **/
            await stripePaymentRequestElement.initStripe(stripePublishableAPIKey)
            
            // Set Publishable Key to card input component
            stripeElement.setAttribute('publishable-key', stripePublishableAPIKey);
            
            // Set Payment Intent Client Secret
            // This is the identifier for the Payment Intent created on the server-side
            stripeElement.setAttribute('intent-client-secret', paymentIntentClientSecret)
            
            // Enable integration with Payment Request Button
            stripeElement.setAttribute('payment-request-button', true)

            /**
             * Disable default form submit handling
             * 
             * This allows custom logic to control card information submission.
             * In real applications, Payment Intent should be confirmed/completed on the server-side.
             **/
            stripeElement.setAttribute('should-use-default-form-submit-action', false);

            /**
             * Custom form submit event handler
             * 
             * This example creates a Payment Method and displays the result, but
             * in real applications you should:
             * 1. Create Payment Method
             * 2. Send to server to confirm Payment Intent
             * 3. Close modal on success
             * 
             * Note: This example does not confirm the Payment Intent.
             * In real implementations, Payment Intent should be confirmed on the server-side.
             * 
             * Example server-side confirmation (Node.js):
             * <pre><code>// Server-side code (Node.js example)
             * const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);
             * 
             * app.post('/confirm-payment', async (req, res) => {
             *   const { paymentMethodId, paymentIntentId } = req.body;
             *   
             *   try {
             *     const paymentIntent = await stripe.paymentIntents.confirm(
             *       paymentIntentId,
             *       { payment_method: paymentMethodId }
             *     );
             *     
             *     res.json({ success: true, paymentIntent });
             *   } catch (error) {
             *     res.status(400).json({ error: error.message });
             *   }
             * });</code></pre>
             **/
            stripeElement.addEventListener('formSubmit', async props => {
              const {
                detail: { stripe, cardNumberElement, event },
              } = props;
              
              // Create Payment Method (pre-step before actual payment processing)
              const result = await stripe.createPaymentMethod({
                type: 'card',
                card: cardNumberElement,
              });
              
              // Display result
              resultElement.innerHTML = `<pre><code>${JSON.stringify(result,null,2)}</code></pre>`
              
              // Update progress state to success
              stripeElement.updateProgress('success');
              
              // Close modal
              await modalElement.closeModal()
            });

            /**
             * Open modal
             * 
             * Setting the 'open' attribute to true displays the modal.
             **/
            modalElement.setAttribute('open', true)
        })
    </script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #f5f5f5;
        line-height: 1.6;
      }
      nav {
        background-color: #fff;
        padding: 1rem;
        border-bottom: 1px solid #e0e0e0;
      }
      nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        gap: 1rem;
      }
      nav a {
        color: #0066cc;
        text-decoration: none;
      }
      nav a:hover {
        text-decoration: underline;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }
      .demo-section,
      .docs-section {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .demo-section h1,
      .docs-section h2 {
        margin-top: 0;
        color: #333;
      }
      .demo-section h1 {
        font-size: 1.5rem;
      }
      .docs-section h2 {
        font-size: 1.25rem;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
      }
      form {
        margin: 1.5rem 0;
      }
      fieldset {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      label {
        display: block;
        margin-bottom: 0.5rem;
      }
      input[type="text"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
      }
      button[type="submit"] {
        background-color: #0066cc;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
      }
      button[type="submit"]:hover {
        background-color: #0052a3;
      }
      #error-message {
        color: #d32f2f;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #ffebee;
        border-radius: 4px;
      }
      #result {
        margin-top: 1.5rem;
      }
      pre {
        background-color: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        border: 1px solid #e0e0e0;
      }
      code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
      }
      pre code {
        display: block;
      }
      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }
        .demo-section {
          order: 1;
        }
        .docs-section {
          order: 2;
        }
      }
    </style>
  </body>
</html>
